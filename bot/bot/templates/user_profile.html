{% extends "layout.html" %}

{% block title %}{{ user.name }} - نقطة وصل{% endblock %}

{% block content %}
<!-- تحسين نمط CSS المخصص -->
<style>
    /* تحسين شكل صورة الملف الشخصي */
    .profile-avatar {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .profile-avatar:hover {
        transform: scale(1.05);
    }
    
    /* تحسين رأس الملف الشخصي */
    .profile-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease;
    }
    
    .profile-header:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }
    
    /* تحسين البطاقات */
    .card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
    }
    
    .card-header {
        background-color: #fff;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 16px 20px;
    }
    
    .card-body {
        padding: 20px;
    }
    
    /* تحسين الإحصائيات */
    .stats-item {
        padding: 12px;
        border-radius: 10px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .stats-item:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
    }
    
    /* تحسين الأزرار */
    .btn {
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.15);
    }
    
    .btn-primary:hover {
        box-shadow: 0 6px 10px rgba(13, 110, 253, 0.2);
        transform: translateY(-2px);
    }
    
    .btn-outline-primary:hover {
        transform: translateY(-2px);
    }
    
    /* تحسين تقييمات المستخدمين */
    .review-item {
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        transition: all 0.3s ease;
    }
    
    .review-item:hover {
        background-color: #e9ecef;
        transform: translateX(3px);
    }
    
    /* تحسين بطاقات المنتجات */
    .product-card {
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .product-card .card-img-top {
        height: 180px;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .product-card:hover .card-img-top {
        transform: scale(1.05);
    }
    
    /* تحسين نجوم التقييم */
    .rating-input .fa-star {
        margin: 0 3px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    
    .rating-input .fa-star:hover {
        transform: scale(1.2);
    }
</style>

<!-- Profile Header -->
<div class="profile-header mb-4 p-4 rounded">
    <div class="row align-items-center">
        <div class="col-auto">
            <img src="{{ user.profile_image_url if user.profile_image_url else (user.profile_image | image_url(folder='users')) }}" 
                alt="{{ user.name }}" 
                class="profile-avatar"
                id="profile-image-preview">
        </div>
        <div class="col">
            <h1 class="h3 mb-1 fw-bold">{{ user.name }}</h1>
            <p class="mb-2 text-muted">
                <i class="fas fa-map-marker-alt me-2"></i>
                {% for loc in locations %}
                    {% if user.location == loc.id %}
                        {{ loc.name }}
                    {% endif %}
                {% endfor %}
            </p>
            <div class="rating mb-2">
                <span class="badge bg-primary">{{ user.rating }}%</span>
                <span class="ms-2 text-muted">({{ user.reviews_count }} تقييم)</span>
            </div>
            <p class="mb-0 small text-muted">
                <i class="fas fa-clock me-1"></i>
                عضو منذ {{ user.created_at | format_date }}
            </p>
        </div>
        {% if current_user.id == user.id %}
        <div class="col-auto">
            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <i class="fas fa-edit me-2"></i>تعديل الملف الشخصي
            </button>
        </div>
        {% endif %}
    </div>
</div>

<div class="row g-4">
    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4 fw-bold"><i class="fas fa-user me-2 text-primary"></i>معلومات المستخدم</h5>
                {% if user.bio %}
                <p class="card-text">{{ user.bio }}</p>
                {% else %}
                <p class="card-text text-muted fst-italic">لم يتم إضافة نبذة شخصية</p>
                {% endif %}
                <hr>
                <ul class="list-unstyled mb-0">
                    {% if user.phone %}
                    <li class="mb-3 d-flex align-items-center">
                        <div class="bg-light rounded-circle p-2 me-3">
                            <i class="fas fa-phone text-primary"></i>
                        </div>
                        <span>{{ user.phone }}</span>
                    </li>
                    {% endif %}
                    <li class="mb-2 d-flex align-items-center">
                        <div class="bg-light rounded-circle p-2 me-3">
                            <i class="fas fa-check-circle {{ 'text-success' if user.is_verified else 'text-warning' }}"></i>
                        </div>
                        <span>{{ 'حساب موثق' if user.is_verified else 'حساب غير موثق' }}</span>
                    </li>
                </ul>
            </div>
        </div>
        
        {% if current_user.id != user.id and current_user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('messages.chat', user_id=user.id) }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-comments me-2"></i>تواصل مع المستخدم
                    </a>
                    
                    {# التحقق من وجود منتجات تم شراؤها من هذا البائع ولم يتم تقييمها بعد #}
                    {% set purchased_products = Product.query.filter_by(seller_id=user.id, buyer_id=current_user.id, is_sold=True).all() %}
                    {% set products_to_review = [] %}
                    
                    {% for product in purchased_products %}
                        {% set already_reviewed = UserReview.query.filter_by(reviewer_id=current_user.id, reviewed_user_id=user.id, product_id=product.id).first() %}
                        {% if not already_reviewed %}
                            {% set _ = products_to_review.append(product) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if products_to_review %}
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">
                            <i class="fas fa-star me-2"></i>إضافة تقييم
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Statistics -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4 fw-bold"><i class="fas fa-chart-line me-2 text-primary"></i>إحصائيات</h5>
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="stats-item">
                            <h3 class="mb-0 fw-bold">{{ user.active_products_count or user.products|length }}</h3>
                            <small class="text-muted">منتج معروض</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-item">
                            <h3 class="mb-0 fw-bold">{{ user.sold_products_count }}</h3>
                            <small class="text-muted">منتج مباع</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-item">
                            <h3 class="mb-0 fw-bold">{{ user.rating | round(1) }}%</h3>
                            <small class="text-muted">متوسط التقييم</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-item">
                            <h3 class="mb-0 fw-bold">{{ user.reviews_count }}</h3>
                            <small class="text-muted">عدد التقييمات</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- User Products -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-shopping-bag me-2 text-primary"></i>المنتجات المعروضة</h5>
            </div>
            <div class="card-body">
                {% if user.products %}
                <div class="row g-4">
                    {% for product in user.products[:6] %}
                    {% if not product.is_sold and product.is_active %}
                    <div class="col-sm-6 col-md-4">
                        <div class="card h-100 product-card">
                            <div class="position-relative overflow-hidden">
                                <a href="{{ url_for('products.view', product_id=product.id) }}">
                                    {% if product.images and product.images|length > 0 %}
                                        {# Find primary image #}
                                        {% set primary_image = None %}
                                        {% for image in product.images if primary_image is none and image.is_primary %}
                                            {% set primary_image = image %}
                                        {% endfor %}
                                        {% if not primary_image %}
                                            {% set primary_image = product.images[0] %}
                                        {% endif %}
                                        <img src="{{ primary_image.url }}" 
                                             class="card-img-top" alt="{{ product.title }}">
                                    {% else %}
                                        <img src="{{ url_for('static', filename='images/products/product-placeholder.jpg') }}" 
                                             class="card-img-top" alt="{{ product.title }}">
                                    {% endif %}
                                </a>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title text-truncate fw-bold">{{ product.title }}</h5>
                                <p class="card-text mb-2">
                                    <span class="text-primary fw-bold">{{ product.price | format_price }}</span>
                                    <small class="text-muted">{{ product.currency }}</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% if has_more_products %}
                <div class="text-center mt-4">
                    <a href="{{ url_for('products.search', seller_id=user.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-list me-2"></i>عرض جميع المنتجات
                    </a>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-box-open fa-3x mb-3"></i>
                    <p>لا توجد منتجات معروضة حالياً</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- User Reviews -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-star me-2 text-primary"></i>تقييمات المستخدمين</h5>
            </div>
            <div class="card-body">
                {% if user.reviews_received %}
                <div class="row">
                    {% for review in user.reviews_received[:5] %}
                    <div class="col-12 mb-3">
                        <div class="review-item">
                            <div class="d-flex mb-2 align-items-center">
                                <img src="{{ review.reviewer.profile_image | image_url(folder='users') }}" 
                                     alt="{{ review.reviewer.name }}" 
                                     class="rounded-circle me-3"
                                     width="50" height="50"
                                     style="object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <div>
                                    <h6 class="mb-0 fw-bold">{{ review.reviewer.name }}</h6>
                                    <div class="rating d-flex align-items-center">
                                        <span class="badge bg-primary me-2">{{ review.rating * 20 }}%</span>
                                        {% if review.product %}
                                        <small class="text-muted">({{ review.product.title }})</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <small class="text-muted ms-auto">
                                    <i class="fas fa-clock me-1"></i>{{ review.created_at | time_since }}
                                </small>
                            </div>
                            {% if review.comment %}
                            <p class="mb-0 mt-2 text-muted">{{ review.comment }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-star fa-3x mb-3"></i>
                    <p>لا توجد تقييمات حتى الآن</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal - تضمين جميع إعدادات الحساب -->
{% if current_user.id == user.id %}
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تعديل الملف الشخصي</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <!-- Tab Navigation for Profile Settings -->
            <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-pane" type="button" role="tab" aria-controls="profile-pane" aria-selected="true">
                        <i class="fas fa-user me-2"></i>المعلومات الشخصية
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-pane" type="button" role="tab" aria-controls="security-pane" aria-selected="false">
                        <i class="fas fa-shield-alt me-2"></i>الأمان
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account-pane" type="button" role="tab" aria-controls="account-pane" aria-selected="false">
                        <i class="fas fa-cog me-2"></i>إعدادات الحساب
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="profileTabsContent">
                <!-- Profile Information Tab -->
                <div class="tab-pane fade show active" id="profile-pane" role="tabpanel" aria-labelledby="profile-tab">
                    <form action="{{ url_for('user.update_profile') }}" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-body">
                            <div class="mb-4 text-center">
                                <img src="{{ user.profile_image_url if user.profile_image_url else (user.profile_image | image_url(folder='users')) }}" 
                                     alt="صورة الملف الشخصي" 
                                     class="rounded-circle mb-3" 
                                     width="120" height="120"
                                     style="object-fit: cover; border: 4px solid #e9ecef; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"
                                     id="profile-image-preview-modal">
                                <div>
                                    <label for="profile_image" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-camera me-2"></i>تغيير الصورة
                                    </label>
                                    <input type="file" id="profile_image" name="profile_image" 
                                           accept="image/*" class="d-none">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="name" class="form-label fw-bold">الاسم</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="name" name="name" 
                                        value="{{ user.name }}" required>
                                    <div class="invalid-feedback">
                                        يرجى إدخال الاسم
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label fw-bold">رقم الهاتف</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    <input type="tel" class="form-control" id="phone" name="phone" 
                                        value="{{ user.phone or '' }}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="location" class="form-label fw-bold">الموقع</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <select class="form-select" id="location" name="location">
                                        <option value="">اختر المحافظة</option>
                                        {% for loc in locations %}
                                        <option value="{{ loc.id }}" {{ 'selected' if user.location == loc.id }}>
                                            {{ loc.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="bio" class="form-label fw-bold">نبذة عني</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                                    <textarea class="form-control" id="bio" name="bio" rows="3">{{ user.bio or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>حفظ التغييرات
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Security Settings Tab -->
                <div class="tab-pane fade" id="security-pane" role="tabpanel" aria-labelledby="security-tab">
                    <div class="modal-body">
                        <h6 class="border-bottom pb-2 mb-3 fw-bold"><i class="fas fa-key me-2 text-primary"></i>تغيير كلمة المرور</h6>
                        <form action="{{ url_for('user.change_password') }}" method="POST" class="needs-validation" id="change-password-form" novalidate>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <label for="current_password" class="form-label">كلمة المرور الحالية</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="current_password" name="current_password" required>
                                    <div class="invalid-feedback">
                                        يرجى إدخال كلمة المرور الحالية
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="new_password" class="form-label">كلمة المرور الجديدة</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-key"></i></span>
                                    <input type="password" class="form-control" id="new_password" name="new_password" 
                                        required minlength="8">
                                    <div class="invalid-feedback">
                                        كلمة المرور الجديدة يجب أن تكون 8 أحرف على الأقل
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">تأكيد كلمة المرور</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-check"></i></span>
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                    <div class="invalid-feedback">
                                        كلمتا المرور غير متطابقتين
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-sync-alt me-2"></i>تغيير كلمة المرور
                                </button>
                            </div>
                        </form>
                        
                        <hr class="my-4">
                        
                        <h6 class="border-bottom pb-2 mb-3 fw-bold"><i class="fas fa-envelope me-2 text-primary"></i>تغيير البريد الإلكتروني</h6>
                        <form action="{{ url_for('user.change_email') }}" method="POST" class="needs-validation" id="change-email-form" novalidate>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <label for="current_email" class="form-label">البريد الإلكتروني الحالي</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="current_email" value="{{ user.email }}" disabled>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="new_email" class="form-label">البريد الإلكتروني الجديد</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="new_email" name="new_email" required>
                                    <div class="invalid-feedback">
                                        يرجى إدخال بريد إلكتروني صحيح
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">كلمة المرور</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <div class="invalid-feedback">
                                        يرجى إدخال كلمة المرور للتأكيد
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle me-2 fa-lg"></i>
                                <div>
                                    سيتم إرسال رسالة تأكيد إلى البريد الإلكتروني الجديد. يرجى التحقق من صندوق الوارد الخاص بك بعد التقديم.
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i>تغيير البريد الإلكتروني
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Account Settings Tab -->
                <div class="tab-pane fade" id="account-pane" role="tabpanel" aria-labelledby="account-tab">
                    <div class="modal-body">
                        <div class="alert alert-danger d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2 fa-lg"></i>
                            <div>
                                <strong>تحذير:</strong> حذف حسابك سيؤدي إلى حذف جميع منتجاتك ورسائلك وبياناتك الشخصية. هذا الإجراء لا يمكن التراجع عنه.
                            </div>
                        </div>
                        <form action="{{ url_for('user.delete_account') }}" method="POST" class="needs-validation" id="delete-account-form" novalidate>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="confirm_delete" id="confirm_delete" required>
                                    <label class="form-check-label" for="confirm_delete">
                                        أنا أدرك أن هذا الإجراء لا يمكن التراجع عنه وأرغب في حذف حسابي نهائياً
                                    </label>
                                    <div class="invalid-feedback">
                                        يجب تأكيد رغبتك في حذف الحساب
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="password_confirm" class="form-label">أدخل كلمة المرور للتأكيد</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="password_confirm" name="password_confirm" required>
                                    <div class="invalid-feedback">
                                        يرجى إدخال كلمة المرور للتأكيد
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash-alt me-2"></i>حذف الحساب
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Review Modal -->
{% if current_user.id != user.id and current_user.is_authenticated %}
{% set purchased_products = Product.query.filter_by(seller_id=user.id, buyer_id=current_user.id, is_sold=True).all() %}
{% set products_to_review = [] %}

{% for product in purchased_products %}
    {% set already_reviewed = UserReview.query.filter_by(reviewer_id=current_user.id, reviewed_user_id=user.id, product_id=product.id).first() %}
    {% if not already_reviewed %}
        {% set _ = products_to_review.append(product) %}
    {% endif %}
{% endfor %}

{% if products_to_review %}
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-star me-2 text-warning"></i>إضافة تقييم</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('user.add_review', user_id=user.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="product_id" class="form-label fw-bold">اختر المنتج الذي اشتريته</label>
                        <select class="form-select" id="product_id" name="product_id" required>
                            <option value="">اختر المنتج</option>
                            {% for product in products_to_review %}
                                <option value="{{ product.id }}">{{ product.title }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                            يرجى اختيار منتج قمت بشرائه
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">تقييمك (نسبة الرضا)</label>
                        <div class="text-center py-3 mb-2" style="background-color: #f8f9fa; border-radius: 10px;">
                            <div class="rating-input" id="rating-input">
                                <i class="fas fa-star fa-2x text-muted" data-rating="1"></i>
                                <i class="fas fa-star fa-2x text-muted" data-rating="2"></i>
                                <i class="fas fa-star fa-2x text-muted" data-rating="3"></i>
                                <i class="fas fa-star fa-2x text-muted" data-rating="4"></i>
                                <i class="fas fa-star fa-2x text-muted" data-rating="5"></i>
                            </div>
                            <input type="hidden" name="rating" id="rating" value="5">
                            <div id="rating-percentage" class="mt-3">
                                <span class="badge bg-primary px-4 py-2">100%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="comment" class="form-label fw-bold">تعليقك</label>
                        <textarea class="form-control" id="comment" name="comment" rows="4" placeholder="شاركنا تجربتك مع هذا البائع..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>إرسال التقييم
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    (function() {
        'use strict';
        
        window.addEventListener('load', function() {
            // Fetch all forms we want to apply validation styles to
            var forms = document.getElementsByClassName('needs-validation');
            
            // Loop over them and prevent submission
            Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    // Password matching validation
                    if (form.id === 'change-password-form') {
                        var password = document.getElementById('new_password');
                        var confirmPassword = document.getElementById('confirm_password');
                        
                        if (password.value !== confirmPassword.value) {
                            confirmPassword.setCustomValidity('كلمتا المرور غير متطابقتين');
                        } else {
                            confirmPassword.setCustomValidity('');
                        }
                    }
                    
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    form.classList.add('was-validated');
                }, false);
                
                // Clear custom validity when typing
                var inputs = form.querySelectorAll('input');
                inputs.forEach(function(input) {
                    input.addEventListener('input', function() {
                        this.setCustomValidity('');
                    });
                });
            });
        });
    })();

    // Profile image preview with animation
    const profileImageInput = document.getElementById('profile_image');
    if (profileImageInput) {
        profileImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewImage = document.getElementById('profile-image-preview-modal');
                    // Add fade out effect
                    previewImage.style.opacity = 0;
                    previewImage.style.transition = 'opacity 0.3s ease';
                    
                    // Change image source after fade out
                    setTimeout(() => {
                        previewImage.src = e.target.result;
                        // Fade in with new image
                        previewImage.style.opacity = 1;
                    }, 300);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Enhanced Rating stars functionality with smooth animation
    const ratingStars = document.querySelectorAll('#rating-input .fa-star');
    const ratingInput = document.getElementById('rating');
    const ratingPercentage = document.getElementById('rating-percentage');
    
    if (ratingStars.length > 0 && ratingInput) {
        // Initialize with default rating
        const initialRating = parseInt(ratingInput.value);
        highlightStars(initialRating);
        
        ratingStars.forEach(star => {
            star.addEventListener('mouseover', function() {
                const rating = parseInt(this.dataset.rating);
                highlightStars(rating);
                
                // Update percentage display with animation
                if (ratingPercentage) {
                    const percentage = rating * 20; // Convert 1-5 to 20-100%
                    ratingPercentage.innerHTML = `<span class="badge bg-primary px-4 py-2">${percentage}%</span>`;
                }
            });
            
            star.addEventListener('mouseout', function() {
                const rating = parseInt(ratingInput.value);
                highlightStars(rating);
                
                // Restore percentage display
                if (ratingPercentage) {
                    const percentage = rating * 20;
                    ratingPercentage.innerHTML = `<span class="badge bg-primary px-4 py-2">${percentage}%</span>`;
                }
            });
            
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                
                // Add a little animation on click
                this.classList.add('clicked');
                setTimeout(() => {
                    this.classList.remove('clicked');
                }, 300);
                
                ratingInput.value = rating;
                highlightStars(rating);
                
                // Set percentage on selection
                if (ratingPercentage) {
                    const percentage = rating * 20;
                    ratingPercentage.innerHTML = `<span class="badge bg-primary px-4 py-2">${percentage}%</span>`;
                }
            });
        });
        
        function highlightStars(rating) {
            ratingStars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                if (starRating <= rating) {
                    star.classList.add('text-warning');
                    star.classList.remove('text-muted');
                } else {
                    star.classList.remove('text-warning');
                    star.classList.add('text-muted');
                }
            });
        }
    }
    
    // Add a little animation for hover effects on cards and buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            .clicked {
                transform: scale(1.3);
                transition: transform 0.2s ease;
            }
            
            .card {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .btn {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            
            .btn:active {
                transform: scale(0.95);
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}